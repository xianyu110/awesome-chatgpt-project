name: Auto Update Links and Timestamp

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ 9 ç‚¹ï¼ˆUTC 1:00ï¼‰æ‰§è¡Œ
    - cron: '0 1 * * *'

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # æ¯å‘¨ä¸€æ¬¡å…¨é¢æ£€æµ‹ï¼ˆå‘¨æ—¥ï¼‰
  # - cron: '0 2 * * 0'

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Check links
        run: |
          echo "ğŸ” å¼€å§‹æ£€æµ‹é“¾æ¥..."
          python3 check_links.py
        continue-on-error: true

      - name: Update README timestamp
        run: |
          echo "â° æ›´æ–°æ—¶é—´æˆ³..."
          python3 update_readme_time.py

      - name: Check for changes
        id: changes
        run: |
          git diff --quiet . || echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: Commit and push if changed
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add README.md link_check_report.md link_check_report.json

          # ç”Ÿæˆæäº¤ä¿¡æ¯
          FAILED_COUNT=$(jq -r '.failed' link_check_report.json)
          SUCCESS_COUNT=$(jq -r '.success' link_check_report.json)
          TOTAL_COUNT=$(jq -r '.total' link_check_report.json)
          SUCCESS_RATE=$(jq -r '.success_rate' link_check_report.json)

          COMMIT_MSG="chore: è‡ªåŠ¨æ›´æ–°é“¾æ¥æ£€æµ‹æŠ¥å‘Š [skip ci]

ğŸ“Š æ£€æµ‹ç»“æœ:
- âœ… æœ‰æ•ˆé“¾æ¥: ${SUCCESS_COUNT}/${TOTAL_COUNT}
- âŒ å¤±æ•ˆé“¾æ¥: ${FAILED_COUNT}
- ğŸ“ˆ æˆåŠŸç‡: ${SUCCESS_RATE}%

ğŸ¤– ç”± GitHub Actions è‡ªåŠ¨æ›´æ–°"

          git commit -m "$COMMIT_MSG"
          git push

      - name: Create issue for failed links
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å¤±æ•ˆé“¾æ¥
          FAILED_COUNT=$(jq -r '.failed' link_check_report.json)

          if [ "$FAILED_COUNT" -gt 0 ]; then
            echo "âš ï¸ å‘ç° ${FAILED_COUNT} ä¸ªå¤±æ•ˆé“¾æ¥ï¼Œåˆ›å»º Issue..."

            # åˆ›å»º Issue å†…å®¹
            ISSUE_TITLE="ğŸ”— å‘ç° ${FAILED_COUNT} ä¸ªå¤±æ•ˆé“¾æ¥éœ€è¦ä¿®å¤"
            ISSUE_BODY="## é“¾æ¥æ£€æµ‹æŠ¥å‘Š

æ£€æµ‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')

### ğŸ“Š ç»Ÿè®¡ä¿¡æ¯
- æ€»é“¾æ¥æ•°: $(jq -r '.total' link_check_report.json)
- âœ… æœ‰æ•ˆé“¾æ¥: $(jq -r '.success' link_check_report.json)
- âŒ å¤±æ•ˆé“¾æ¥: ${FAILED_COUNT}
- æˆåŠŸç‡: $(jq -r '.success_rate' link_check_report.json)%

### âŒ å¤±æ•ˆé“¾æ¥åˆ—è¡¨

$(jq -r '.results[] | select(.status=="failed") | "- [\(.text)](\(.url)) - é”™è¯¯: \(.message)"' link_check_report.json)

### ğŸ“‹ è¯¦ç»†æŠ¥å‘Š
æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š: [link_check_report.md](./link_check_report.md)

---
ğŸ¤– æ­¤ Issue ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º"

            # ä½¿ç”¨ gh CLI åˆ›å»º Issue
            echo "$ISSUE_BODY" | gh issue create \
              --title "$ISSUE_TITLE" \
              --body-file - \
              --label "automated,links" || true
          else
            echo "âœ… æ‰€æœ‰é“¾æ¥éƒ½æ­£å¸¸"
          fi
